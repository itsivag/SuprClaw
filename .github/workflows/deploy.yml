name: Deploy Backend to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon

      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          DIGITALOCEAN_API_KEY=${{ secrets.DIGITALOCEAN_API_KEY }}
          DIGITALOCEAN_SSH_KEYS=${{ secrets.DIGITALOCEAN_SSH_KEYS }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          OPENCLAW_SNAPSHOT_ID=${{ secrets.OPENCLAW_SNAPSHOT_ID }}
          DOMAIN=${{ secrets.DOMAIN }}
          FIREBASE_CREDENTIALS_PATH=${{ secrets.FIREBASE_CREDENTIALS_PATH }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          SUPRCLAW_DEVICE_PRIVATE_KEY_B64=${{ secrets.SUPRCLAW_DEVICE_PRIVATE_KEY_B64 }}
          SUPRCLAW_DEVICE_PUBLIC_KEY_B64=${{ secrets.SUPRCLAW_DEVICE_PUBLIC_KEY_B64 }}
          SUPRCLAW_STATIC_DEVICE_ID=${{ secrets.SUPRCLAW_STATIC_DEVICE_ID }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          EOF

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp build/libs/*.jar deploy/
          cp .env deploy/
          cp setup-wildcard-ssl.sh deploy/ || echo "Warning: setup-wildcard-ssl.sh not found"
          tar -czf suprclaw-deploy.tar.gz -C deploy .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          echo "SSH key setup complete"
          ls -la ~/.ssh/deploy_key

      - name: Debug connection info
        run: |
          echo "DEPLOY_USER length: ${#DEPLOY_USER}"
          echo "SERVER_IP length: ${#SERVER_IP}"
          echo "Testing connection to: $DEPLOY_USER@$SERVER_IP"
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful'"

      - name: Upload to server
        run: |
          scp -i ~/.ssh/deploy_key suprclaw-deploy.tar.gz ${{ secrets.DEPLOY_USER }}@${{ secrets.SERVER_IP }}:~/

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            cd ~

            # Backup config files BEFORE moving directory
            if [ -d "SuprClaw" ]; then
              cp SuprClaw/.env ~/.env.backup 2>/dev/null || echo "No .env to backup"
              cp SuprClaw/firebase-credentials.json ~/.firebase-credentials.backup 2>/dev/null || echo "No firebase-credentials.json to backup"
              mv SuprClaw SuprClaw.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # Extract new deployment
            mkdir -p SuprClaw
            tar -xzf suprclaw-deploy.tar.gz -C SuprClaw/
            cd SuprClaw

            # Create necessary directories
            mkdir -p logs build/libs

            # Move JAR to correct location
            mv *.jar build/libs/ 2>/dev/null || true

            # Restore config files from backup
            if [ -f ~/.env.backup ]; then
              mv ~/.env.backup .env
              echo "✅ Restored .env from backup"
            else
              echo "⚠️  Warning: No .env backup found - service may fail to start"
            fi

            if [ -f ~/.firebase-credentials.backup ]; then
              mv ~/.firebase-credentials.backup firebase-credentials.json
              echo "✅ Restored firebase-credentials.json from backup"
            else
              echo "⚠️  Warning: No firebase-credentials.json backup found"
            fi

            # Set proper permissions
            chmod 600 .env firebase-credentials.json 2>/dev/null || true

            # Create/update systemd service (using printf - no heredoc to avoid YAML issues)
            printf '%s\n' \
              '[Unit]' \
              'Description=SuprClaw Backend API' \
              'After=network.target' \
              '' \
              '[Service]' \
              'Type=simple' \
              'User=suprclaw' \
              'WorkingDirectory=/home/suprclaw/SuprClaw' \
              'EnvironmentFile=/home/suprclaw/SuprClaw/.env' \
              'ExecStart=/usr/bin/java -Xmx1024m -Xms512m -jar /home/suprclaw/SuprClaw/build/libs/SuprClaw-all.jar' \
              'Restart=always' \
              'RestartSec=10' \
              'StandardOutput=journal' \
              'StandardError=journal' \
              'SyslogIdentifier=suprclaw-backend' \
              '' \
              '[Install]' \
              'WantedBy=multi-user.target' \
              | sudo tee /etc/systemd/system/suprclaw-backend.service > /dev/null

            # Reload systemd to pick up service changes
            sudo systemctl daemon-reload

            # Fix SSL certificate permissions (if needed)
            if [ -d "/etc/letsencrypt/live/suprclaw.com" ]; then
              sudo chmod 755 /etc/letsencrypt/live /etc/letsencrypt/archive
              sudo chmod 755 /etc/letsencrypt/live/suprclaw.com /etc/letsencrypt/archive/suprclaw.com
              sudo chmod 644 /etc/letsencrypt/archive/suprclaw.com/*.pem
              sudo chmod 640 /etc/letsencrypt/archive/suprclaw.com/privkey*.pem
              sudo chgrp suprclaw /etc/letsencrypt/archive/suprclaw.com/privkey*.pem
            fi

            # Restart service
            sudo systemctl restart suprclaw-backend

            # Wait for service to start
            sleep 5

            # Check service status
            if sudo systemctl is-active --quiet suprclaw-backend; then
              echo "✅ Deployment successful! Service is running."
              sudo systemctl status suprclaw-backend --no-pager
            else
              echo "❌ Deployment failed! Service is not running."
              sudo journalctl -u suprclaw-backend -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 5
          curl -f https://api.suprclaw.com/ || echo "Warning: API health check failed"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f suprclaw-deploy.tar.gz
